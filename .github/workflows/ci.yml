name: Plugin CI

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install ruff

      - name: Run ruff check
        id: ruff_check
        run: |
          # å…ˆå°è¯•è‡ªåŠ¨ä¿®å¤
          ruff check --fix plugin.py || true
          # å†æ£€æŸ¥
          if ! ruff check plugin.py; then
            echo "ruff_failed=true" >> $GITHUB_ENV
            exit 1
          fi

      - name: Auto-fix ruff issues
        if: env.ruff_failed == 'true'
        run: |
          ruff check --fix plugin.py
          echo "ðŸ”§ è‡ªåŠ¨ä¿®å¤ ruff é—®é¢˜..."
          git config user.email "yuki-bot@nekro.ai"
          git config user.name "Yuki Bot"
          git add plugin.py
          git commit -m "ðŸ¤– Auto-fix ruff issues" || echo "æ— éœ€ä¿®å¤"
          git push || echo "æ— éœ€æŽ¨é€"

      - name: Retry ruff check after fix
        if: env.ruff_failed == 'true'
        run: |
          ruff check plugin.py

  syntax-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Syntax check
        run: |
          python -m py_compile plugin.py
          echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡"

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install basedpyright
        run: |
          pip install basedpyright

      - name: Install nekro-agent (>=2.2.0)
        run: |
          pip install "nekro-agent>=2.2.0"

      - name: Run basedpyright type check
        run: |
          basedpyright --version
          basedpyright plugin.py

  notify-failure:
    runs-on: ubuntu-latest
    needs: [lint, syntax-check, type-check]
    if: failure()
    steps:
      - name: Send failure notification
        run: |
          echo "ðŸ”´ CI å¤±è´¥é€šçŸ¥"
          echo "Job: ${{ github.job }}"
          echo "Repo: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
