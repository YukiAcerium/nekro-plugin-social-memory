name: Plugin CI

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install ruff

      - name: Run ruff check
        id: ruff_check
        run: |
          if ! ruff check plugin.py; then
            echo "ruff_failed=true" >> $GITHUB_ENV
            exit 1
          fi

      - name: Auto-fix ruff issues
        if: env.ruff_failed == 'true'
        run: |
          ruff check --fix plugin.py
          echo "ğŸ”§ è‡ªåŠ¨ä¿®å¤ ruff é—®é¢˜..."
          git config user.email "yuki-bot@nekro.ai"
          git config user.name "Yuki Bot"
          git add plugin.py
          git commit -m "ğŸ¤– Auto-fix ruff issues" || echo "æ— éœ€ä¿®å¤"
          git push || echo "æ— éœ€æ¨é€"

      - name: Retry ruff check after fix
        if: env.ruff_failed == 'true'
        run: |
          ruff check plugin.py

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install pyright

      - name: Run pyright
        run: |
          pyright plugin.py --pythonversion 3.11

  import-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install pydantic

      - name: Test import
        run: |
          python -c "from plugin import plugin; print('Import OK')"

  notify-failure:
    runs-on: ubuntu-latest
    needs: [lint, type-check, import-test]
    if: failure()
    steps:
      - name: Send failure notification
        run: |
          echo "ğŸ”´ CI å¤±è´¥é€šçŸ¥"
          echo "Job: ${{ github.job }}"
          echo "Repo: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          # é‚®ä»¶é€šçŸ¥ç”± GitHub Actions åŸç”Ÿæ”¯æŒ
          # åœ¨ GitHub repo settings > Notifications > Email ä¸­é…ç½®
